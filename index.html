<script>
    // åº—é‹ªå¹´åº¦ç›®æ¨™æ˜ å°„ï¼ˆä¿ç•™ï¼Œä½œç‚ºæ•¸æ“šæ¬„ä½åç¨±åƒè€ƒï¼Œä½†ä¸å†ä½œç‚ºä¸»è¦è­˜åˆ¥ä¾æ“šï¼‰
    const storeYearTargets = {
        425500: 'ä¸­æ¸¯åº—',
        280000: 'ä¸­å‹åº—',
        85000: 'å°ä¸­ä¸‰äº•åº—',
        110000: 'è€æ–¯åº—',
        120000: 'å‚æ¥Šåº—'
    };

    // ğŸ’¡ åº—é‹ªé—œéµå­—åˆ—è¡¨ - ç”¨æ–¼å¾ row[0] è­˜åˆ¥åº—å
    const storeKeywords = {
        'ä¸­æ¸¯': 'ä¸­æ¸¯åº—',
        'ä¸­å‹': 'ä¸­å‹åº—',
        'ä¸‰äº•': 'å°ä¸­ä¸‰äº•åº—',
        'è€æ–¯': 'è€æ–¯åº—',
        'å‚æ¥Š': 'å‚æ¥Šåº—'
    };

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const resultsSection = document.getElementById('resultsSection');

    // é»æ“Šä¸Šå‚³
    uploadArea.addEventListener('click', () => fileInput.click());

    // æ‹–æ›³åŠŸèƒ½
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    // æ–‡ä»¶é¸æ“‡
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    async function handleFile(file) {
        const fileName = file.name.toLowerCase();
        
        if (!fileName.endsWith('.xlsx')) {
            alert('è«‹ä¸Šå‚³ Excel æ–‡ä»¶ï¼ˆ.xlsxæ ¼å¼ï¼‰ï¼');
            return;
        }

        try {
            const arrayBuffer = await file.arrayBuffer();
            // è®€å– Excel æª”æ¡ˆ
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            // è½‰æ›ç‚º JSON æ•¸æ“šï¼Œheader: 1 è¡¨ç¤ºå°‡æ•¸æ“šä½œç‚ºé™£åˆ—è™•ç†
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // è§£æExcelæ•¸æ“š
            const result = parseExcelData(jsonData);
            
            // é¡¯ç¤ºçµæœ
            displayResults(result.data, result.dates);
            
        } catch (error) {
            console.error('Excelè§£æéŒ¯èª¤:', error);
            alert('Excelè§£æå¤±æ•—ï¼è«‹ç¢ºèªæ–‡ä»¶æ ¼å¼æ­£ç¢ºã€‚');
        }
    }

    function parseExcelData(jsonData) {
        const data = {};
        let dates = {
            reportDate: '',
            monthRange: '',
            yearRange: ''
        };
        
        // å¾ç¬¬ä¸€è¡Œæå–æ—¥æœŸè³‡è¨Š (ä¸è®Š)
        if (jsonData.length > 0) {
            const firstRow = jsonData[0];
            
            for (let cell of firstRow) {
                if (cell && typeof cell === 'string') {
                    // å ±è¡¨æ—¥æœŸ
                    const reportDateMatch = cell.match(/(\d{1,2}\/\d{1,2})\s*$/);
                    if (reportDateMatch && !dates.reportDate) {
                        dates.reportDate = reportDateMatch[1];
                    }
                    
                    // æœˆä»½ç¯„åœå’Œå¹´åº¦ç¯„åœ
                    const monthRangeMatch = cell.match(/(\d{1,2}\/\d{1,2}~\d{1,2}\/\d{1,2})/);
                    if (monthRangeMatch) {
                        const range = monthRangeMatch[1];
                        if (!range.startsWith('1/1')) {
                            dates.monthRange = range;
                        } else {
                            dates.yearRange = range;
                        }
                    }
                }
            }
        }
        
        // å¾ç¬¬3è¡Œé–‹å§‹è§£ææ•¸æ“šï¼ˆç´¢å¼• i=2ï¼‰
        for (let i = 2; i < jsonData.length; i++) {
            const row = jsonData[i];
            
            // ç¢ºä¿è¡Œæœ‰è¶³å¤ æ•¸æ“šä¸”ç¬¬1æ¬„ä¸ç‚ºç©º
            if (!row || row.length < 30 || !row[0]) continue; 
            
            const cellA = String(row[0]).trim(); // å–å¾—ç¬¬1æ¬„çš„æ–‡å­—å…§å®¹ (ç´¢å¼• 0)
            let storeName = '';

            // ğŸ’¡ æ ¸å¿ƒå„ªåŒ–ï¼šä½¿ç”¨é—œéµå­—è­˜åˆ¥åº—å (æ‚¨çš„åº—åˆ¥æŠ“å–é‚è¼¯)
            for (const keyword in storeKeywords) {
                if (cellA.includes(keyword)) {
                    storeName = storeKeywords[keyword];
                    break;
                }
            }
            
            // åªæœ‰æˆåŠŸè­˜åˆ¥åˆ°åº—åæ‰é€²è¡Œæ•¸æ“šæå–
            if (storeName) {
                const yearTarget = row[2];
                
                console.log(`âœ“ è­˜åˆ¥åˆ° ${storeName}ï¼ˆå¾ row[0] è­˜åˆ¥ï¼Œå¹´åº¦ç›®æ¨™ï¼š${yearTarget}ï¼‰`);
                
                data[storeName] = {
                    // æ¬„ä½ç´¢å¼•ä¿æŒä¸è®Š
                    yearTarget: yearTarget,
                    monthTarget: row[3],
                    monthActual: row[10],
                    monthEstimate: row[11],
                    monthEstimateRate: (row[12] * 100).toFixed(2),
                    monthEstimateDiff: row[13],
                    lastYearMonth: row[15],
                    monthGrowthRate: (row[16] * 100).toFixed(2),
                    monthGrowthAmount: row[17],
                    monthTargetRate: (row[26] * 100).toFixed(2),
                    monthTargetDiff: row[27],
                    yearActual: row[18],
                    yearEstimate: row[19],
                    yearEstimateRate: (row[20] * 100).toFixed(2),
                    yearEstimateDiff: row[21],
                    lastYearSamePeriod: row[23],
                    yearGrowthRate: (row[24] * 100).toFixed(2),
                    yearGrowthAmount: row[25],
                    yearTargetRate: (row[28] * 100).toFixed(2),
                    yearTargetDiff: row[29]
                };
            }
        }
        
        return { data, dates };
    }

    function displayResults(data, dates) {
        const monthlyBody = document.getElementById('monthlyBody');
        const yearlyBody = document.getElementById('yearlyBody');
        const reportDateBadge = document.getElementById('reportDate');
        const monthTitle = document.getElementById('monthTitle');
        const yearTitle = document.getElementById('yearTitle');
        
        // æ›´æ–°æ—¥æœŸé¡¯ç¤º (ä¸è®Š)
        if (dates.reportDate) {
            reportDateBadge.textContent = dates.reportDate;
        }
        if (dates.monthRange) {
            monthTitle.textContent = `ğŸ“… æœˆä»½æ•¸æ“šï¼ˆ${dates.monthRange}ï¼‰`;
        }
        if (dates.yearRange) {
            yearTitle.textContent = `ğŸ“ˆ å¹´åº¦æ•¸æ“šï¼ˆ${dates.yearRange}ï¼‰`;
        }
        
        monthlyBody.innerHTML = '';
        yearlyBody.innerHTML = '';

        const storeOrder = ['ä¸­æ¸¯åº—', 'ä¸­å‹åº—', 'å°ä¸­ä¸‰äº•åº—', 'è€æ–¯åº—', 'å‚æ¥Šåº—'];

        storeOrder.forEach(storeName => {
            if (data[storeName]) {
                const d = data[storeName];
                
                // æœˆä»½æ•¸æ“š (ä¸è®Š)
                const monthRow = `
                    <tr>
                        <td class="store-name">${storeName}</td>
                        <td>${formatNumber(d.monthTarget)}</td>
                        <td>${formatNumber(d.monthEstimate)}</td>
                        <td>${formatNumber(d.monthActual)}</td>
                        <td>${d.monthEstimateRate}%</td>
                        <td class="${d.monthEstimateDiff >= 0 ? 'positive' : 'negative'}">${formatNumber(d.monthEstimateDiff)}</td>
                        <td>${formatNumber(d.lastYearMonth)}</td>
                        <td class="${parseFloat(d.monthGrowthRate) >= 0 ? 'positive' : 'negative'}">${d.monthGrowthRate}%</td>
                        <td class="${d.monthGrowthAmount >= 0 ? 'positive' : 'negative'}">${formatNumber(d.monthGrowthAmount)}</td>
                        <td>${d.monthTargetRate}%</td>
                        <td class="${d.monthTargetDiff >= 0 ? 'positive' : 'negative'}">${formatNumber(d.monthTargetDiff)}</td>
                    </tr>
                `;
                monthlyBody.innerHTML += monthRow;

                // å¹´åº¦æ•¸æ“š (ä¸è®Š)
                const yearRow = `
                    <tr>
                        <td class="store-name">${storeName}</td>
                        <td>${formatNumber(d.yearTarget)}</td>
                        <td>${formatNumber(d.yearEstimate)}</td>
                        <td>${formatNumber(d.yearActual)}</td>
                        <td>${d.yearEstimateRate}%</td>
                        <td class="${d.yearEstimateDiff >= 0 ? 'positive' : 'negative'}">${formatNumber(d.yearEstimateDiff)}</td>
                        <td>${formatNumber(d.lastYearSamePeriod)}</td>
                        <td class="${parseFloat(d.yearGrowthRate) >= 0 ? 'positive' : 'negative'}">${d.yearGrowthRate}%</td>
                        <td class="${d.yearGrowthAmount >= 0 ? 'positive' : 'negative'}">${formatNumber(d.yearGrowthAmount)}</td>
                        <td>${d.yearTargetRate}%</td>
                        <td class="${d.yearTargetDiff >= 0 ? 'positive' : 'negative'}">${formatNumber(d.yearTargetDiff)}</td>
                    </tr>
                `;
                yearlyBody.innerHTML += yearRow;
            }
        });

        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function formatNumber(num) {
        if (num === undefined || num === null) return '0';
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // ğŸ’¡ ç§»é™¤æˆ–æ›¿æ› exportToExcel å‡½æ•¸ï¼Œå› ç‚ºæ‚¨ä¸éœ€è¦åŒ¯å‡º
    function exportToExcel() {
        alert('æ­¤åŠŸèƒ½å·²åœç”¨ï¼Œå› æ‚¨ä¸éœ€è¦åŒ¯å‡ºå ±è¡¨ã€‚');
        // æ‚¨ä¹Ÿå¯ä»¥å°‡æ­¤å‡½æ•¸ç›´æ¥ç§»é™¤ï¼Œä¸¦å¾ HTML ä¸­åˆªé™¤æŒ‰éˆ•
    }
</script>
